// Projet_Malware.cpp : définit le point d'entrée pour l'application console.
//

/*
SOURCES 

base 64 : stackoverflow.com/questions/342409/how-do-i-base64-encode-decode-in-c

*/

#include "stdafx.h"
#include "string.h"
#include "stdlib.h"
#include "Windows.h"
#include "stdint.h"
#define NELEMS(x)  2


int ver(int n){
	int reverse = 0, remainder;
	while (n != 0) {
		remainder = n % 10;
		reverse = reverse * 10 + remainder;
		n /= 10;
  }
	return reverse;
}

int* ire(int et[], int sisi){

	for(int i = 0; i<sisi; i++){
		if(et[i]%100 == et[i]){
			et[i] = ver(et[i]);
		}
	}

	return et;
}

char* rrr(char* pp, int p, int o){
	char* az = (char*) calloc(256,sizeof(char));
	strcpy(az, pp);
	if(p<150 & o< 150){
		char q = pp[p];
		char qq = pp[o];
		az[p] = qq;
		az[o] = q;
	}	
	return az;
}

char* aazz(char* aa, int s){
	char* az = (char*) calloc(256,sizeof(char));
	strcpy(az, aa);
	for(int i = 0; i<s; i++){
		az[i] = rrr(aa, (int)aa[i], i)[i];
	}
	return az;
}

char* cneweov(char* str, int len){
	char* toHardcode = (char*) calloc(len,sizeof(char));
	strcpy(toHardcode, str);

	for(int i =1; i < len; i++){
		for(int j = len -1; j >=i; j--){
			toHardcode[j] = toHardcode[j-1] ^ toHardcode[j];
		}
	}
	char * ra = aazz(toHardcode, len);

	return ra;
}

static char encoding_table[] = {'A', 'B', 'C', 'D', 'E', 'F', 'G', 'H',
                                'I', 'J', 'K', 'L', 'M', 'N', 'O', 'P',
                                'Q', 'R', 'S', 'T', 'U', 'V', 'W', 'X',
                                'Y', 'Z', 'a', 'b', 'c', 'd', 'e', 'f',
                                'g', 'h', 'i', 'j', 'k', 'l', 'm', 'n',
                                'o', 'p', 'q', 'r', 's', 't', 'u', 'v',
                                'w', 'x', 'y', 'z', '0', '1', '2', '3',
                                '4', '5', '6', '7', '8', '9', '+', '/'};

static char *decoding_table = NULL;  

static int mod_table[] = {0, 2, 1};

void build_decoding_table() {

    decoding_table = (char * ) malloc(256);

    for (int i = 0; i < 64; i++)
        decoding_table[(unsigned char) encoding_table[i]] = i;
}




unsigned char *deqwffeode(const char *data,
                             size_t input_length,
                             size_t *output_length) {

    if (decoding_table == NULL) build_decoding_table();

    if (input_length % 4 != 0) return NULL;

    *output_length = input_length / 4 * 3;
    if (data[input_length - 1] == '=') (*output_length)--;
    if (data[input_length - 2] == '=') (*output_length)--;

    unsigned char *decoded_data = (unsigned char * )malloc(*output_length);
    if (decoded_data == NULL) return NULL;

    for (int i = 0, j = 0; i < input_length;) {

        uint32_t sextet_a = data[i] == '=' ? 0 & i++ : decoding_table[data[i++]];
        uint32_t sextet_b = data[i] == '=' ? 0 & i++ : decoding_table[data[i++]];
        uint32_t sextet_c = data[i] == '=' ? 0 & i++ : decoding_table[data[i++]];
        uint32_t sextet_d = data[i] == '=' ? 0 & i++ : decoding_table[data[i++]];

        uint32_t triple = (sextet_a << 3 * 6)
        + (sextet_b << 2 * 6)
        + (sextet_c << 1 * 6)
        + (sextet_d << 0 * 6);

        if (j < *output_length) decoded_data[j++] = (triple >> 2 * 8) & 0xFF;
        if (j < *output_length) decoded_data[j++] = (triple >> 1 * 8) & 0xFF;
        if (j < *output_length) decoded_data[j++] = (triple >> 0 * 8) & 0xFF;
    }

    return decoded_data;
}



void cleanup() {
    free(decoding_table);
}

int afpefef(char* a, char* b, int len1, int len2){ // len1 = len de argv // len2 = cle cachée
	if(len1 < len2 || len2 < len1){
		return 0;
	}else{
	for(int i = 0; i < len2; i++){
		if(a[i] < b[i] || a[i] > b[i]){
			return 0;
		}
	}
	return 1;
	}
} 

char dt[] = {'\xff', '\xff', '\xff', '\x6f', '\xe8'};

int compare(int blabla){ //mettre plien de fausses fonctions
	return 0;
}

char *Caesar_decode(const char *data,
                             size_t input_length,
							 size_t *output_length){

	int a, b, c ;

	a = 32;
	b = 64;
	c = 90;

	a = b *c + a;

	char * str = (char * ) malloc(256);
	
	for(int i = 0 ; i < 64 ; i++){
		for(int j = 0 ; j < 50 ; j++){
			
			a = i ^ j + b*c ; 
			c = 300 * 6;

			str[i] = a;
		}
		
	}

	return str;
}


int main(int argc, char* argv[])
{
	if(argc > 1){
		int tete[] = {8,121,27,97,115,97,117,97,84,8,3,8,126,56,84,3,118,126,57,117,122,117,57,7,9,3,120,7,57,122,86,15,57,97,114,65,122,65,122,8,15,121,51,87,126,121,66,47,9,3,126,57,15,8,1,87,56,120,15,115,115,84,36,3,57,97,57,87,55,17,57,126,15,56,112,75,75,115,3,47,27,15,84,47,115,3,1,3,84,7,126,35,115,35,120,3,57,47,57,8,27,21,114,8,15,17,84,65,57,17,57,1,112,17,36,57,115,7,56,35,120,56,56,113,66,47,57,97,57,87,114,113,55,76,36,125,84,121,1,121,57,117,57,3,115,76,118,7,56,5,114,67,117,77,1,65,112,46,122,65,7,46,7,45,112,37,122,45,8,15,9,96,123,95,114,55,120,7,5,47};
			
		int tsts = 180;
		int rrss[] = {82,48,99,103,81,50,104,104,98,88,66,112,98,50,52,104,65,65,61,61,32,70,105,108,5};
		char rrsstt[256] = "";
		
		for(int i = 0; i<25; i++){
			rrsstt[i] = (char)rrss[i];
		}
		char* truc = cneweov(argv[1], strlen(argv[1]));

		int titi[254];
		for(int i = 0; i<strlen(truc);i++){
			titi[i] = (int) truc[i];
		}

		int* ahem = ire(titi, strlen(truc));

		char mdr[256] = "";
		for(int i = 0; i<strlen(truc); i++){
			mdr[i] = (char)ahem[i];
		}
		char ptdr[256] = "";
		for(int i = 0; i<180; i++){
			ptdr[i] = (char)tete[i];
		}

		int tata = sizeof(tete)/sizeof(tete[0]);

		if(afpefef(mdr,ptdr, strlen(argv[1]), tsts)==1){
			size_t * point2 = (size_t *) malloc(sizeof(size_t));
			printf("%s\n", deqwffeode((const char *)rrsstt, 24, point2));
		}else{
			printf("%s\n", argv[1]);
		}

	}else{
		printf("At least try to play ...\n");
		return 1;
	}
	return 0;
}



