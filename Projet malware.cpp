// Projet_Malware.cpp : définit le point d'entrée pour l'application console.
//

/*
SOURCES 

base 64 : stackoverflow.com/questions/342409/how-do-i-base64-encode-decode-in-c

*/

#include "stdafx.h"
#include "string.h"
#include "stdlib.h"
#include "Windows.h"
#include "stdint.h"
#define NELEMS(x)  2


int ver(int n){
	int anata = 0, hitohito;
	while (n != 0) {
		hitohito = n % 10;
		anata = anata * 10 + hitohito;
		n /= 10;
  }
	return anata;
}

int* ire(int et[], int sisi){

	for(int i = 0; i<sisi; i++){
		if(et[i]%100 == et[i]){
			et[i] = ver(et[i]);
		}
	}
	for(int i = 0; i<sisi; i++){
		et[i] = (1234*et[i])%139;
	}

	return et;
}


char* rrr(char* pp, int p, int o){
	char* az = (char*) calloc(256,sizeof(char));
	strcpy(az, pp);
	if(p<150 & o< 150){
		char q = pp[p];
		char qq = pp[o];
		az[p] = qq;
		az[o] = q;
	}	
	return az;
}

char* aazz(char* aa, int s){
	char* az = (char*) calloc(256,sizeof(char));
	strcpy(az, aa);
	for(int i = 0; i<s; i++){
		az[i] = rrr(aa, (int)aa[i], i)[i];
	}
	return az;
}

char* cneweov(char* str, int len){
	char* to = (char*) calloc(len,sizeof(char));
	strcpy(to, str);

	for(int i =1; i < len; i++){
		for(int j = len -1; j >=i; j--){
			to[j] = to[j-1] ^ to[j];
		}
	}
	char * ra = aazz(to, len);

	return ra;
}

static char encoding_table[] = {'A', 'B', 'C', 'D', 'E', 'F', 'G', 'H',
                                'I', 'J', 'K', 'L', 'M', 'N', 'O', 'P',
                                'Q', 'R', 'S', 'T', 'U', 'V', 'W', 'X',
                                'Y', 'Z', 'a', 'b', 'c', 'd', 'e', 'f',
                                'g', 'h', 'i', 'j', 'k', 'l', 'm', 'n',
                                'o', 'p', 'q', 'r', 's', 't', 'u', 'v',
                                'w', 'x', 'y', 'z', '0', '1', '2', '3',
                                '4', '5', '6', '7', '8', '9', '+', '/'};

static char *decoding_table = NULL;  

static int mod_table[] = {0, 2, 1};

void build_decoding_table() {

    decoding_table = (char * ) malloc(256);

    for (int i = 0; i < 64; i++)
        decoding_table[(unsigned char) encoding_table[i]] = i;
}



unsigned char *deqwffeode(const char *data,
                             size_t input_length,
                             size_t *output_length) {

    if (decoding_table == NULL) build_decoding_table();

    if (input_length % 4 != 0) return NULL;

    *output_length = input_length / 4 * 3;
    if (data[input_length - 1] == '=') (*output_length)--;
    if (data[input_length - 2] == '=') (*output_length)--;

    unsigned char *decoded_data = (unsigned char * )malloc(*output_length);
    if (decoded_data == NULL) return NULL;

    for (int i = 0, j = 0; i < input_length;) {

        uint32_t sextet_a = data[i] == '=' ? 0 & i++ : decoding_table[data[i++]];
        uint32_t sextet_b = data[i] == '=' ? 0 & i++ : decoding_table[data[i++]];
        uint32_t sextet_c = data[i] == '=' ? 0 & i++ : decoding_table[data[i++]];
        uint32_t sextet_d = data[i] == '=' ? 0 & i++ : decoding_table[data[i++]];

        uint32_t triple = (sextet_a << 3 * 6)
        + (sextet_b << 2 * 6)
        + (sextet_c << 1 * 6)
        + (sextet_d << 0 * 6);

        if (j < *output_length) decoded_data[j++] = (triple >> 2 * 8) & 0xFF;
        if (j < *output_length) decoded_data[j++] = (triple >> 1 * 8) & 0xFF;
        if (j < *output_length) decoded_data[j++] = (triple >> 0 * 8) & 0xFF;
    }

    return decoded_data;
}



void cleanup() {
    free(decoding_table);
}

int afpefef(char* a, char* b, int len1, int len2){ // len1 = len de argv // len2 = cle cachée
	if(len1 < len2 || len2 < len1){
		return 0;
	}else{
	for(int i = 0; i < len2; i++){
		if(a[i] < b[i] || a[i] > b[i]){
			return 0;
		}
	}
	return 1;
	}
} 

char dt[] = {'\xff', '\xff', '\xff', '\x6f', '\xe8'};

int compare(int blabla){
	return 0;
}

char *Caesar_decode(const char *data,
                             size_t input_length,
							 size_t *output_length){

	int a, b, c ;

	a = 32;
	b = 64;
	c = 90;

	a = b *c + a;

	char * str = (char * ) malloc(256);
	
	for(int i = 0 ; i < 64 ; i++){
		for(int j = 0 ; j < 50 ; j++){
			
			a = i ^ j + b*c ; 
			c = 300 * 6;

			str[i] = a;
		}
		
	}

	return str;
}


int main(int argc, char* argv[])
{
	if(IsDebuggerPresent()){
		printf("Enleve moi ce debuggeur");
		return 0;
	};
	if(argc > 1){
		int tete[] = {3,28,97,19,130,19,96,19,101,3,88,3,82,21,101,88,79,82,4,96,11,96,4,20,125,88,45,20,4,11,67,23,4,19,8,7,11,7,11,3,23,28,106,50,82,28,129,35,125,88,82,4,23,3,122,50,21,45,23,130,130,101,83,88,4,19,4,50,38,128,4,82,23,21,42,115,115,130,88,35,97,23,101,35,130,88,122,88,101,20,82,100,130,100,45,88,4,35,4,3,97,60,8,3,23,128,101,7,4,128,4,122,42,128,83,4,130,20,21,100,45,21,21,25,129,35,4,19,4,50,8,25,38,98,83,99,101,28,122,28,4,96,4,88,130,98,79,20,21,54,8,112,96,81,122,7,42,52,11,7,20,52,20,69,42,66,11,69,3,23,125,36,133,53,8,38,45,20,54,35};
		if(IsDebuggerPresent()){
			printf("Enleve moi ce debuggeur");
			return 0;
		};	
		int tsts = 180;
		int rrss[] = {82,48,99,103,81,50,104,104,98,88,66,112,98,50,52,104,65,65,61,61,32,70,105,108,5};
		char rrsstt[256] = "";
		if(IsDebuggerPresent()){
			printf("Enleve moi ce debuggeur");
			return 0;
		};	
		for(int i = 0; i<25; i++){
			rrsstt[i] = (char)rrss[i];
			if(IsDebuggerPresent()){
				printf("Enleve moi ce debuggeur");
				return 0;
			};	
		}
		char* truc = cneweov(argv[1], strlen(argv[1]));
		if(IsDebuggerPresent()){
			printf("Enleve moi ce debuggeur");
			return 0;
		};	
		int titi[254];
		for(int i = 0; i<strlen(truc);i++){
			titi[i] = (int) truc[i];
			if(IsDebuggerPresent()){
				printf("Enleve moi ce debuggeur");
				return 0;
		};	
		}

		int* ahem = ire(titi, strlen(truc));
		if(IsDebuggerPresent()){
			printf("Enleve moi ce debuggeur");
			return 0;
		};	
		char mdr[256] = "";
		for(int i = 0; i<strlen(truc); i++){
			mdr[i] = (char)ahem[i];
		}
		if(IsDebuggerPresent()){
			printf("Enleve moi ce debuggeur");
			return 0;
		};	
		char ptdr[256] = "";
		for(int i = 0; i<180; i++){
			ptdr[i] = (char)tete[i];
			if(IsDebuggerPresent()){
				printf("Enleve moi ce debuggeur");
				return 0;
		};	
		}

		int tata = sizeof(tete)/sizeof(tete[0]);
		if(IsDebuggerPresent()){
			printf("Enleve moi ce debuggeur");
			return 0;
		};	
		if(afpefef(mdr,ptdr, strlen(argv[1]), tsts)==1){
			size_t * point2 = (size_t *) malloc(sizeof(size_t));
			if(IsDebuggerPresent()){
				printf("Enleve moi ce debuggeur");
				return 0;
		};	
			printf("%s\n", deqwffeode((const char *)rrsstt, 24, point2));
		}else{
			if(IsDebuggerPresent()){
				printf("Enleve moi ce debuggeur");
				return 0;
			};	
			printf("%s\n", argv[1]);
		}

	}else{
		if(IsDebuggerPresent()){
			printf("Enleve moi ce debuggeur");
			return 0;
		};	
		printf("At least try to play ...\n");
		return 1;
	}
	return 0;
}



